// #################################################################################################
//  com.aworx.util - Classes we need
//
//  (c) 2013-2015 A-Worx GmbH, Germany
//  Published under MIT License (Open Source License, see LICENSE.txt)
// #################################################################################################

using System;
using System.Diagnostics;
using System.Globalization;

namespace com.aworx.util  {

/** ************************************************************************************************
 * <summary>
 * This class provides an interface into system dependent time values (usually 64 bit
 * tick counters) that we call *ticks*. Ticks allow to store and calculate time values in an
 * efficient and highly accurate way. Such time values may represent points in time as well
 * as time span. It is up to the user of this class to determine what type of time value is
 * stored. It is recommended to use class TickWatch rather than this low level interface.
 *
 * Ticks generated by this class can be added and subtracted:
 *
 * - Subtraction generates a *span value in ticks*
 * - *Span value in ticks* can be added to themselves  safely
 * - *Span value in ticks* can be added to ticks safely
 *
 * Conversion functions to and from milliseconds, microseconds and nanoseconds accept time points
 * and time spans the same manner.
 *
 * As Ticks are system dependent, their values should not be stored in system independent data files or
 * otherwise shared between systems. In general such values should only be used by methods of
 * this class and class TickWatch.
 *
 * The resolution and accuracy of the values is platform dependent. Especially nanoseconds are
 * deemed to be not accurate and above 100 ns (this was written and fact in 2013).
 * </summary>
 **************************************************************************************************/
public class Ticks
{
    // #############################################################################################
    // static fields and methods
    // #############################################################################################
        /** ****************************************************************************************
         * <summary>
         *  The Frequency of the internal tick timer. The Frequency gives you an indication of the
         *  accuracy of the time (At least if the underlying system library is reasonably well working in
         *  this respect). And this is the reason why it is published with this field. This value does
         *  not necessarily correspond to the number of ticks per second that you get from this classes
         *  Raw method.
         * </summary>
         ******************************************************************************************/
        public  static readonly        long             InternalFrequency;

        /** ****************************************************************************************
         * <summary>
         *  The time (in ticks) when the ticker library containing the ticker (AWXU) was initialized.
         *  This might be useful to measure the time since the process was started.
         * </summary>
         ******************************************************************************************/
        public  static readonly        Ticks            CreationTime;

        /// <summary> The DateTime.Now.Ticks at 1/1/1970 0:00:00. </summary> */
        private static readonly        long             dateTimeTicks19700101;

        /// <summary> A stopwatch started when static constructor is invoked. </summary> */
        private static readonly        Stopwatch        creationTimeStopWatch;

        /// <summary> A conversion factor between stopwatch ticks and DateTimeTicks. </summary> */
        private static readonly        double           convSWToDT;

        static Ticks()
        {
            // This static constructor is called once at the beginning of the life-cycle of this library.
            // We use it to create
            //  a) a reference counter in DateTime ticks initialized to now and
            //  b) a Stopwatch object that we are starting.
            // Within the Now() function of this class, we are then converting the Stopwatch measurement
            // and add it to the initial timer.
            // So, why are we doing this instead of just using DateTime.Now in method Now()?
            // The answer is: DateTime.Now is very inefficient, because it creates a heap object that is
            // then disposed right away. This version of Now() is around 15 times faster on the compiling platform.

            CreationTime=            new Ticks( DateTime.Now.Ticks );

            // for the conversion in "millis since the epoch" we need the reference DayTime ticks
            dateTimeTicks19700101=  (new DateTime( 1970, 1, 1, 0, 0, 0 )).Ticks;

            creationTimeStopWatch=   new Stopwatch();
            creationTimeStopWatch.Start();

            InternalFrequency=       Stopwatch.Frequency;

            // conversion factor StopWatch to DateTime is:
            //    10 million nanoseconds (the DateTime ticks per second) / by frequency of stopwatch
            convSWToDT=    10000000d / (double) InternalFrequency;
        }

    // #############################################################################################
    // Private fields
    // #############################################################################################

        /// <summary> The value. </summary> */
        protected                      long             ticks;

        /**  */
        /// <summary> A temporary ticks object. used for as a return value. </summary> */
        protected                      Ticks            tempTicks;


    // #############################################################################################
    // Constructors
    // #############################################################################################

        /** ********************************************************************************************
         * <summary>
         *  Creates a Ticks instance representing the point in time when this constructor was invoked.
         * </summary>
         ******************************************************************************************/
        public                  Ticks( )                {    Set();                }
        /** ****************************************************************************************
         * <summary>
         *  Creates a Ticks instance representing the same point in time or time span as the instance provided.
         * </summary>
         * <param name="copy">  The instance to copy the ticks value from. </param>
         ******************************************************************************************/
        public                  Ticks( Ticks copy )     {    ticks=  copy.ticks;     }

        /** ****************************************************************************************
         * <summary>
         *  Creates a Ticks instance representing a given time point or time span in ticks.
         * </summary>
         * <param name="ticks">   The value to copy into this. </param>
         ******************************************************************************************/
        public                  Ticks( long ticks )     {    this.ticks=  ticks;     }


    // #############################################################################################
    // Interface
    // #############################################################################################

        /** ****************************************************************************************
         * <summary>
         *     Sets the actual point in time as the value of this instance.
         * </summary>
         ******************************************************************************************/
        public void             Set()
        {
            // same as DateTime.Now.Ticks, but much faster
            #if !ALOX_WP71
                ticks=  CreationTime.ticks +  (long)  ( ((double) creationTimeStopWatch.ElapsedTicks) * convSWToDT ) ;
            #else
                value=  DateTime.Now.Ticks;
            #endif
        }

        /** ****************************************************************************************
         * <summary>
         *    Sets the point in time or time span represented by this instance to the value represented by
         *    the given Ticks instance.
         * </summary>
         * <param name="other"> The Ticks object to retrieve the new ticks value from. </param>
         ******************************************************************************************/
        public void             Set( Ticks other )      {    this.ticks=            other.ticks;    }

        /** ****************************************************************************************
         * <summary>
         *    Sets this objects' value to the value specified in ticks.
         * </summary>
         * <param name="value"> The ticks value to set  </param>
         ******************************************************************************************/
        public void             SetRaw( long value )    {    this.ticks=            value;            }

        /** ****************************************************************************************
         * <summary>
         *    Gets the internally stored system dependent time in ticks.
         * </summary>
         * <returns>  The internal value    </returns>
         ******************************************************************************************/
        public long             Raw()                   {    return         ticks;                    }

        /** ****************************************************************************************
         * <summary>
         *    Adds the point in time or time span represented by the given Ticks instance to this instance.
         * </summary>
         * <param name="other"> The Ticks object to add the ticks from. </param>
         ******************************************************************************************/
        public void             Add( Ticks other )      {    this.ticks+=        other.ticks;    }

        /** ****************************************************************************************
         * <summary>
         *    Adds the point in time or time span represented by the given Ticks instance to this instance.
         * </summary>
         * <param name="value"> The ticks to add. </param>
         ******************************************************************************************/
        public void             Add( long value )       {    this.ticks+=        value;    }

        /** ****************************************************************************************
         * <summary>
         *    Subtracts the point in time or time span represented by the given Ticks instance from this instance.
         * </summary>
         * <param name="other"> The Ticks object to subtract the ticks from. </param>
         ******************************************************************************************/
        public void             Sub( Ticks other )      {    this.ticks-=        other.ticks;    }

        /** ****************************************************************************************
         * <summary>
         *    Subtracts the point in time or time span represented by the given Ticks instance from this instance.
         * </summary>
         * <param name="value"> The ticks to subtract. </param>
         ******************************************************************************************/
        public void             Sub( long value )       {    this.ticks-=        value;    }


    // #############################################################################################
    // Interface Age, Since
    // #############################################################################################

        /** ****************************************************************************************
         * <summary>
         *  Returns the time span between value represented by this instance and the current system time.
         *  If the internal value represents a historic point in time, the result is positive.
         *
         *  Note: Attention: The object returned is a temporary object, deemed to be reused by other
         *  interface methods of this instance. Therefore, it must be used only until subsequent
         *  method invocations on this instance are performed (hence, also not thread safe!)
         *  Use #Age(Ticks result) to provide a dedicated external result instance.
         * </summary>
         *
         * <returns>  The age of this instance, stored in a temporary object, not thread safe object. </returns>
         ******************************************************************************************/
        public     Ticks    Age( )
        {
            if (tempTicks == null )
                tempTicks= new Ticks( 0L );
            return Age( tempTicks );
        }

        /** ****************************************************************************************
         * <summary>
         *  Returns the time span between value represented by this instance and the current  time.
         *  If the internal value represents a historic point in time, the result is positive.
         * </summary>
         *
         * <param name="result">   The Ticks object to store the result in. If null, this is created.
         *                         </param>
         * <returns>  The age of this instance, stored in the given or created object. </returns>
         ******************************************************************************************/
        public     Ticks    Age( Ticks result )
        {
            if ( result == null )
                result= new Ticks();
            else
                result.Set();
            result.Sub( this );
            return result;
        }


        /** ****************************************************************************************
         * <summary>
         *  Returns the time span between the value represented by this instance and the given TickWatch.
         *  If the given TickWatch represents an earlier point in time, the result is positive.
         *
         *  Note: Attention: The object returned is a temporary object, deemed to be reused by other
         *  interface methods of this instance. Therefore, it must be used only until subsequent
         *  method invocations on this instance are performed (hence, also not thread safe!)
         *  Use #Since(Ticks result, Ticks result) to provide a dedicated external result instance.
         * </summary>
         *
         * <param name="olderTime">   The value to compare this instance with
         *
         * <returns>  The calculated time span, stored in a temporary object, not thread safe object </returns>
         ******************************************************************************************/
        public     Ticks    Since( Ticks olderTime )
        {
            if (tempTicks == null )
                tempTicks= new Ticks( 0L );
            return Since( olderTime, tempTicks );
        }

        /** ****************************************************************************************
         * <summary>
         *  Returns the time span between the value represented by this instance and the given TickWatch.
         *  If the given TickWatch represents an earlier point in time, the result is positive.
         *
         * </summary>
         *
         * <param name="olderTime"> The value to compare this instance with
         * <param name="result">    The Ticks object to store the result in. If null, this is created.
         *                          </param>
         *
         * <returns>  The calculated time span, stored in the given or created object. </returns>
         ******************************************************************************************/
        public     Ticks    Since( Ticks olderTime, Ticks result )
        {
            if ( result == null )
                result= new Ticks( this );
            else
                result.Set( this );

            result.Sub( olderTime );
            return    result;
        }



    // #############################################################################################
    // Conversion to/from time values (nanoseconds, milliseconds, microseconds, seconds)
    // #############################################################################################

        /** ****************************************************************************************
         * <summary> Converts the internal value to days. </summary>
         * <returns>  The internal value converted to days. </returns>
         ******************************************************************************************/
        public    long          InDays()                { return    ticks /  8640000000000000L;    }

        /** ****************************************************************************************
         * <summary> Converts the internal value to hours. </summary>
         * <returns>  The internal value converted to hours. </returns>
         ******************************************************************************************/
        public    long          InHours()               { return    ticks /   360000000000000L;    }

        /** ****************************************************************************************
         * <summary> Converts the internal value to minutes. </summary>
         * <returns>  The internal value converted to minutes. </returns>
         ******************************************************************************************/
        public    long          InMinutes()             { return    ticks /    6000000000000L;     }

        /** ****************************************************************************************
         * <summary> Converts the internal value to seconds. </summary>
         * <returns>  The internal value converted to seconds. </returns>
         ******************************************************************************************/
        public    long          InSeconds()             { return    ticks /         10000000L;     }

        /** ****************************************************************************************
         * <summary> Converts the internal value to milliseconds. </summary>
         * <returns>  The internal value converted to milliseconds. </returns>
         ******************************************************************************************/
        public    long          InMillis()              { return    ticks /            10000L;     }

        /** ****************************************************************************************
         * <summary> Converts the internal value to microseconds. </summary>
         * <returns>  The internal value converted to microseconds. </returns>
         ******************************************************************************************/
        public    long          InMicros()              { return    ticks /               10L;     }

        /** ****************************************************************************************
         * <summary> Converts the internal value to nanoseconds. </summary>
         * <returns>  The internal value converted to nanoseconds. </returns>
         ******************************************************************************************/
        public    long          InNanos    ()           { return    ticks *              100L;     }

        /** ****************************************************************************************
         * <summary>
         *  Returns 1 divided by internal value in seconds, hence the number of Hertz that this Ticks
         *  object represents when interpreted as a time span.
         * </summary>
         *
         * <param name="nDigitsPrec">    Number of digits that the return value will be rounded to.
         *                                Defaults to -1 which means no rounding.</param>
         *
         * <returns>    A double value representing the frequency in hertz. </returns>
         ******************************************************************************************/
        public    double        InHertz    ( int nDigitsPrec= -1 )
        {
            // check
            if ( ticks == 0)
                return 0.0;

            // calc hertz
            double hz= ((double) 10000000d) / ticks;

            // no rounding? that's it
            if ( nDigitsPrec < 0 )
                return hz;

            // round
            double mag= Math.Pow( 10, nDigitsPrec );
            return ( (int) ( hz * mag + ( hz < 0 ? -0.5 : 0.5 )) ) / mag;
        }

        /** ****************************************************************************************
         * <summary> Sets the internal value to a time span provided in days. </summary>
         * <param name="days">  The time span to set in days. </param>
         ******************************************************************************************/
        public    void          FromDays   ( long days )     { ticks=    days * 8640000000000000L;  }

        /** ****************************************************************************************
         * <summary> Sets the internal value to a time span provided in hours. </summary>
         * <param name="hours">  The time span to set in hours. </param>
         ******************************************************************************************/
        public    void          FromHours  ( long hours )    { ticks=    hours*  360000000000000L;  }

        /** ****************************************************************************************
         * <summary> Sets the internal value to a time span provided in minutes. </summary>
         * <param name="mins">  The time span to set in minutes. </param>
         ******************************************************************************************/
        public    void          FromMinutes( long mins )     { ticks=    mins *    6000000000000L;  }

        /** ****************************************************************************************
         * <summary> Sets the internal value to a time span provided in seconds. </summary>
         * <param name="secs">  The time span to set in seconds. </param>
         ******************************************************************************************/
        public    void          FromSeconds( long secs )     { ticks=    secs *         10000000L;  }

        /** ****************************************************************************************
         * <summary> Sets the internal value to a time span provided in milliseconds. </summary>
         * <param name="millis">    The time span to set in milliseconds. </param>
         ******************************************************************************************/
        public    void          FromMillis ( long millis )   { ticks=    millis *          10000L;  }

        /** ****************************************************************************************
         * <summary> Sets the internal value to a time span provided in microseconds. </summary>
         * <param name="micros">  The time span to set in microseconds. </param>
         ******************************************************************************************/
        public    void          FromMicros ( long micros )   { ticks=    micros *           10L;    }

        /** ****************************************************************************************
         * <summary> Sets the internal value to a time span provided in nanoseconds. </summary>
         * <param name="nanos">  The time span to set in nanoseconds. </param>
         ******************************************************************************************/
        public    void          FromNanos  ( long nanos )    { ticks=    nanos /           100L;    }


    // #############################################################################################
    // Conversion to platform/language specific time objects
    // #############################################################################################

        /** ****************************************************************************************
         * <summary>
         *  Converts the internal value into milliseconds since January 1, 1970, 00:00:00 GMT.
         *  The conversion is dependent on time zone and system clock setting of the host.
         * </summary>
         * <returns> Milliseconds in the epoch. </returns>
         ******************************************************************************************/
        public    long          InEpochMillis()                 { return ( ticks - dateTimeTicks19700101 ) /      10000L;    }

        /** ****************************************************************************************
         * <summary>
         *  Sets the internal value by converting the given milliseconds since January 1, 1970, 00:00:00 GMT.
         *  The conversion is dependent on time zone and system clock setting of the host.
         * </summary>
         * <param name="epochMillis">The milliseconds in the epoch to convert. </param>
         ******************************************************************************************/
        public    void          SetFromEpochMillis( long epochMillis ) { ticks= dateTimeTicks19700101 + ( epochMillis * 10000L); }


        /** ****************************************************************************************
         * <summary>
         *  Converts the internal value to DateTime ticks.
         *  The conversion is dependent on time zone and system clock setting of the host.
         * </summary>
         * <returns> The converted DateTime compatible ticks value. </returns>
         ******************************************************************************************/
        public     long         InDotNetDateTimeTicks()         { return ticks;    }

        /** ****************************************************************************************
         * <summary>
         *  Sets the internal value by converting the given DateTime.
         *  The conversion is dependent on time zone and system clock setting of the host.
         * </summary>
         * <param name="dateTime">A DateTime instance to read and convert the ticks from. </param>
         ******************************************************************************************/
        public     void         SetFromDotNetDateTime( DateTime dateTime )    { ticks= dateTime.Ticks;    }

        /** ****************************************************************************************
         * <summary>
         *  Converts the internal value to DateTime.
         *  The conversion is dependent on time zone and system clock setting of the host.
         * </summary>
         * <returns> A corresponding DateTime object. </returns>
         ******************************************************************************************/
        public     DateTime         InDotNetDateTime()          { return new DateTime ( ticks );    }

}


/** ************************************************************************************************
 * <summary>
 *  This class encapsulates a system dependent time value (Ticks) and provides some basic
 *  interface for measuring time spans, including multiple samples and their average.
 *
 *  The interface does provide nanosecond versions the methods. However, the internal resolution
 *  of the used timer is system dependent and might be lower than nanoseconds.
 * </summary>
 **************************************************************************************************/
public class TickWatch
{
    // #############################################################################################
    // Internal fields
    // #############################################################################################

        /// <summary> The value. </summary>
        protected        Ticks          ticks                                           =new Ticks( 0L );

        /// <summary> The number of samples performed. </summary>
        protected        int            cntSamples                                      = 0;

        /// <summary> The sum of the samples times. </summary>
        protected        Ticks          sum                                             =new Ticks( 0L );

        /// <summary> A temporary Ticks used as a return value </summary>
        protected        Ticks          tempTicks;


    // #############################################################################################
    // Constructors
    // #############################################################################################

        /** ****************************************************************************************
         * <summary>     Creates a TickWatch representing the current point in time. </summary>
         ******************************************************************************************/
        public              TickWatch    ()                  {    Reset();                }

        /** ****************************************************************************************
         * <summary>     Creates a TickWatch as a copy of another TickWatch.    </summary>
         *
         * <param name="copy"> The instance to copy value from. </param>
         ******************************************************************************************/
        public              TickWatch    ( TickWatch copy )
        {
            ticks       .Set( copy.ticks );
            sum         .Set( copy.sum );
            cntSamples= copy.cntSamples;
        }



    // #############################################################################################
    // Interface Get/Set/Reset
    // #############################################################################################

        /** ****************************************************************************************
         * <summary> Returns the internally stored value. </summary>
         * <returns>    The internally stored value in ticks.. </returns>
         ******************************************************************************************/
        public    Ticks     GetStartTime()            { return ticks;         }

        /** ****************************************************************************************
         * <summary> Sets the internal value to current system time to 'now'. </summary>
         ******************************************************************************************/
        public    void      Start()                   { ticks.Set();          }

        /** ****************************************************************************************
         * <summary> Sets the internal start time value. </summary>
         * <param name="t">    The value. </param>
         ******************************************************************************************/
        public    void      SetStartTime( Ticks t )   { ticks.Set( t );       }


        /** ****************************************************************************************
         * <summary>
         *  Sets the internal value to current system time and clears existing sum and quantity of
         *  samples.
         * </summary>
         ******************************************************************************************/
        public     void     Reset()                   { sum.SetRaw( 0L ) ; cntSamples= 0;  Start(); }


    // #############################################################################################
    // Interface to Measurement
    // #############################################################################################

        /** ****************************************************************************************
         * <summary>
         *  Returns the time span between the current system time and the internal reference value.
         *  In addition this value is added to the sum of sample times and the sample counter is
         *  increased by one. Lastly the internal reference value is set to now. Therefore, a
         *  subsequent call to this function would measure the time span from this call to this
         *  subsequent call (if the internal reference value was not set differently meanwhile).
         *  Other interface methods dealing with samples are #GetSampleCnt, #GetCumulated and
         *  #GetAverage.
         *
         * </summary>
         * <returns>
         *    The time difference between the current system time and the internal reference value.
         * </returns>
         ******************************************************************************************/
        public         Ticks    Sample    ()
        {
            if (tempTicks == null )
                tempTicks= new Ticks( 0L );

            cntSamples++;
            long old=    ticks.Raw();
            ticks.Set();
            long  diff=  ticks.Raw() - old;

            tempTicks.SetRaw( diff );
            sum.Add( diff );

            return tempTicks;
        }

        /** ****************************************************************************************
         * <summary>
        *     Returns the number of calls to #Sample since this instance was created or #Reset was invoked.
        *  </summary>
         * <returns>The number of samples taken.</returns>
         ******************************************************************************************/
        public         int    GetSampleCnt()            { return cntSamples; }

        /** ****************************************************************************************
         * <summary>
         *    Returns the cumulated length of all samples taken since this instance was created or cleared.
         *    Note: the object returned will be reused in subsequent calls to this method. Hence, previously
          *    returned values will be overwritten!
         * </summary>
         * <returns>  The cumulated length of all samples taken since the last reset. </returns>
         ******************************************************************************************/
        public        Ticks    GetCumulated()           { return sum; }

        /** ****************************************************************************************
         * <summary>
         *  Returns the average length of all samples since this instance was created or reset.
         *  If no measurement was performed, the result value will be set to 0 ticks.
         *
         *  Note: Attention: The object returned is a temporary object, deemed to be reused by other
         *  interface methods of this instance. Therefore, it must be used only until subsequent
         *  method invocations on this instance are performed (hence, also not thread safe!)
         *  Use #GetAverage(Ticks result) to provide a dedicated external result instance.
         * </summary>
         *
         * <returns> The average length of all samples taken since the last reset. </returns>
         ******************************************************************************************/
        public        Ticks    GetAverage()
        {
            if (tempTicks == null )
                tempTicks= new Ticks( 0L );
            return new Ticks( cntSamples== 0 ? 0L     :    (sum.Raw() / cntSamples) );
        }

        /** ****************************************************************************************
         * <summary>
         *    Returns the average length of all samples since this instance was created or reset.
         *    If no measurement was performed, the result value will be set to 0 ticks.
         * </summary>
         *
         * <param name="result">  An object to store the result in. If not provided (null), a result
         *                        object is created. </param>
         *
         * <returns>  The average sample time within the given or created object. </returns>
         ******************************************************************************************/
        public        Ticks    GetAverage( Ticks result )
        {
            if ( result == null )
                result= new Ticks();

            result.SetRaw( cntSamples== 0 ? 0L   :    (sum.Raw() / cntSamples) );
            return  result;
        }


    // #############################################################################################
    // Conversion to time platform/language specific objects
    // #############################################################################################

        /** ****************************************************************************************
         * <summary>    Returns a  String that represents this object. </summary>
         * <returns>    A String that represents this object. </returns>
         ******************************************************************************************/
        public override String        ToString()
        {
            return  ticks.InDotNetDateTime().ToString( CultureInfo.InvariantCulture );
        }


}


} // namespace / EOF
